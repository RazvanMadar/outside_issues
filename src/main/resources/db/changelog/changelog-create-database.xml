<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="20230501120000" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="citizens"/>
            </not>
        </preConditions>
        <createTable tableName="citizens">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(255)">
            </column>
            <column name="last_name" type="VARCHAR(255)">
            </column>
            <column name="password" type="VARCHAR(255)">
            </column>
            <column name="phone_number" type="VARCHAR(255)">
            </column>
        </createTable>
    </changeSet>

    <!--        create issues table   -->
    <changeSet id="20230501121000" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="issues"/>
            </not>
        </preConditions>
        <createTable tableName="issues">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="actual_location" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lat" type="double">
            </column>
            <column name="lng" type="double">
            </column>
            <column name="citizen_email" type="VARCHAR(255)">
            </column>
            <column name="description" type="VARCHAR(255)">
            </column>
            <column name="dislikes_number" type="int">
            </column>
            <column name="likes_number" type="int">
            </column>
            <column name="has_location" type="boolean">
            </column>
            <column name="reported_date" type="date">
            </column>
            <column name="state" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!--        create roles table   -->
    <changeSet id="20230501122000" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="roles"/>
            </not>
        </preConditions>
        <createTable tableName="roles">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!--        create roles table   -->
    <changeSet id="20230501123000" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="citizens_roles"/>
            </not>
        </preConditions>
        <createTable tableName="citizens_roles">
            <column name="citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="role_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="citizens_roles"
                                 baseColumnNames="citizen_id"
                                 constraintName="fk_citizen_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="citizens_roles"
                                 baseColumnNames="role_id"
                                 constraintName="fk_role_id"
                                 referencedTableName="roles"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20230501123500" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="citizen_images"/>
            </not>
        </preConditions>
        <createTable tableName="citizen_images">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="image" type="bytea">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(255)">
            </column>
            <column name="citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="citizen_images"
                                 baseColumnNames="citizen_id"
                                 constraintName="fk_citizen_image_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20230501124000" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="issue_images"/>
            </not>
        </preConditions>
        <createTable tableName="issue_images">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="image" type="bytea">
                <constraints nullable="false"/>
            </column>
            <column name="number" type="varchar(255)">
            </column>
            <column name="type" type="varchar(255)">
            </column>
            <column name="issue_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="issue_images"
                                 baseColumnNames="issue_id"
                                 constraintName="fk_issue_image_id"
                                 referencedTableName="issues"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20230501125000" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="rejected_issues"/>
            </not>
        </preConditions>
        <createTable tableName="rejected_issues">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="rejected_number" type="bigint">
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="rejected_issues"
                                 baseColumnNames="citizen_id"
                                 constraintName="fk_citizen_rejected_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20230501125100" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="citizens_reactions"/>
            </not>
        </preConditions>
        <createTable tableName="citizens_reactions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="type" type="boolean">
            </column>
            <column name="citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="issue_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="citizens_reactions"
                                 baseColumnNames="citizen_id"
                                 constraintName="fk_citizen_reaction_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="citizens_reactions"
                                 baseColumnNames="issue_id"
                                 constraintName="fk_issue_reaction_id"
                                 referencedTableName="issues"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20230501125200" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="messages"/>
            </not>
        </preConditions>
        <createTable tableName="messages">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="date" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
            </column>
            <column name="message" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="from_citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="to_citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="messages"
                                 baseColumnNames="from_citizen_id"
                                 constraintName="fk_from_citizen_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="messages"
                                 baseColumnNames="to_citizen_id"
                                 constraintName="fk_to_citizen_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20230501125300" author="razvan.madar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="blacklists"/>
            </not>
        </preConditions>
        <createTable tableName="blacklists">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="citizen_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="blacklists"
                                 baseColumnNames="citizen_id"
                                 constraintName="fk_blocked_citizen_id"
                                 referencedTableName="citizens"
                                 referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>